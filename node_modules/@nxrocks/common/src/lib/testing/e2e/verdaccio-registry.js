"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.disableVerdaccioRegistry = exports.enableVerdaccioRegistry = exports.spawnVerdaccioRegistry = void 0;
const app_root_1 = require("@nrwl/workspace/src/utils/app-root");
const child_process_1 = require("child_process");
const path = require("path");
function spawnVerdaccioRegistry(port = 4873) {
    return new Promise((resolve, reject) => {
        const pathVerdaccioModule = require.resolve("verdaccio/bin/verdaccio");
        const configPath = path.join(app_root_1.appRootPath, ".verdaccio", "config.yaml");
        const childFork = child_process_1.fork(pathVerdaccioModule, ["-c", configPath, '-l', `${port}`], {
            silent: false,
        });
        childFork
            .on("message", (msg) => msg['verdaccio_started'] && resolve(childFork))
            .on("exit", (code) => reject(`exited with code: ${code}`))
            .on("error", (err) => reject(`errored : ${err}`))
            .on("disconnect", () => reject(['disconnected']));
        console.log('starting local registry');
    });
}
exports.spawnVerdaccioRegistry = spawnVerdaccioRegistry;
function enableVerdaccioRegistry(port = 4873) {
    try {
        console.log(`Enabling local registry on port ${port}...`);
        child_process_1.execSync(`npm config set registry http://localhost:${port}/`);
        child_process_1.execSync(`yarn config set registry http://localhost:${port}/`);
    }
    catch (e) {
        console.error(e);
    }
}
exports.enableVerdaccioRegistry = enableVerdaccioRegistry;
function disableVerdaccioRegistry() {
    try {
        child_process_1.execSync(`npm config delete registry`);
        child_process_1.execSync(`yarn config delete registry`);
        const CURRENT_NPM_REGISTRY = child_process_1.execSync('npm config get registry').toString('utf-8').trim();
        const CURRENT_YARN_REGISTRY = child_process_1.execSync('yarn config get registry').toString('utf-8').trim();
        console.log(` Reverted registries`);
        console.log(` > NPM:  ${CURRENT_NPM_REGISTRY}`);
        console.log(` > YARN: ${CURRENT_YARN_REGISTRY}`);
    }
    catch (e) {
        console.error(e);
    }
}
exports.disableVerdaccioRegistry = disableVerdaccioRegistry;
//# sourceMappingURL=verdaccio-registry.js.map