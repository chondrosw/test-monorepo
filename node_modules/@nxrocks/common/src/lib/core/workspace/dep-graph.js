"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getProjectGraph = exports.addDependenciesForProject = exports.getPackageInfosForNxProjects = void 0;
const devkit_1 = require("@nrwl/devkit");
const path_1 = require("path");
function getPackageInfosForNxProjects(pluginName, projectFilter, getPackageInfo, workspace) {
    const workspacePackageInfo = {
        projects: {},
        packages: {}
    };
    Object.entries(workspace.projects).filter(([, project]) => projectFilter(project))
        .forEach(([projectName, project]) => {
        try {
            const pkgInfo = getPackageInfo(project);
            workspacePackageInfo.projects[projectName] = pkgInfo;
            workspacePackageInfo.packages[pkgInfo.packageId] = projectName;
        }
        catch (e) {
            if (process.env.NX_VERBOSE_LOGGING === 'true') {
                devkit_1.logger.warn(`[${pluginName}]: Failed to get package info for project '${projectName}'`);
                devkit_1.logger.warn(e);
            }
        }
    });
    return workspacePackageInfo;
}
exports.getPackageInfosForNxProjects = getPackageInfosForNxProjects;
function addDependenciesForProject(pluginName, rootProjectFolder, rootProjectName, rootPkgInfo, builder, workspace) {
    if (process.env.NX_VERBOSE_LOGGING === 'true') {
        devkit_1.logger.debug(`[${pluginName}]: Adding dependencies for project '${rootProjectName}'...`);
    }
    rootPkgInfo.dependencies.forEach(depPkgInfo => {
        const depProjectName = workspace.packages[depPkgInfo.packageId];
        if (depProjectName) {
            builder.addExplicitDependency(rootProjectName, path_1.join(rootProjectFolder, rootPkgInfo.packageFile), depProjectName);
        }
    });
}
exports.addDependenciesForProject = addDependenciesForProject;
function getProjectGraph(pluginName, projectFilter, getPackageInfo, graph, context) {
    const builder = new devkit_1.ProjectGraphBuilder(graph);
    if (process.env.NX_VERBOSE_LOGGING === 'true') {
        devkit_1.logger.debug(`[${pluginName}]: Looking related projects inside the workspace...`);
    }
    const workspace = getPackageInfosForNxProjects(pluginName, projectFilter, getPackageInfo, context.workspace);
    Object.entries(workspace.projects).forEach(([projectName, pkgInfo]) => {
        addDependenciesForProject(pluginName, graph.nodes[projectName].data.root, projectName, pkgInfo, builder, workspace);
    });
    return builder.getUpdatedProjectGraph();
}
exports.getProjectGraph = getProjectGraph;
//# sourceMappingURL=dep-graph.js.map